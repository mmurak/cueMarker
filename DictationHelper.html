<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
  <head>
    <title>Dictation Helper Ver. 1.03</title>
    <link rel="shortcut icon" href="./redKiwiBird.png">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <script src="./scripts/wavesurfer.js"></script>
    <style>
    textarea {
        width: 100%;
        resize: vertical;
        font-family: Times New Roman;
        font-size: 18pt;
    }
    .zoomer{
        width: 10%;
        background: #ccffcc;
    }
    .player{
        width: 25%;
        font-size: 150%;
        background: #ccccff;
    }
    .stamper{
        width: 25%;
        font-size: 150%;
        background: #ffcccc;
    }
    .speeder{
        width: 35%;
    }
    @media screen and (max-width: 959px) {
        .fileSection{
            font-size: 150%;
        }
        .zoomer{
            width: 30%;
            font-size: 150%;
        }
        .player{
            width: 45%;
            padding: 30px 10px 30px 10px;
        }
        .stamper{
            width: 45%;
        }
    }
    </style>
  </head>
  <body">
      <div class="fileSection">Sound/Script file: <input type="file" id="mediaFile" accept=".mp3,.webm,.mp4,.mkv,.wav,.txt" /></div><br/>
      <input type="button" id="zoomInButton" class="zoomer" value="Zoom In" onclick="zoomIn();"/>
      <input type="button" id="zoomOutButton" class="zoomer" value="Zoom Out" disabled onclick="zoomOut();"/>
      <input id="timerField" size="8" disabled style="text-align:right"/>
      <br/>
      <div id="waveform"></div>
      <input type="button" id="playButton" class="player" value="Press Player" disabled/>
      <input type="button" id="playButton2" class="player" value="Click&Click Player" disabled/>
      Speed:<input type="range" id="speedRange" value="44" class="speeder" list="myTickList" oninput="speedControl();"/>
      <datalist id="myTickList">
      <option value="11">
      <option value="22">
      <option value="33">
      <option value="44">
      <option value="55">
      <option value="66">
      <option value="77">
      <option value="88">
      <option value="100">
      </datalist>
      <span id="playSpeed">100</span>%
      <br/>
      <input type="button" id="stampButton" class="stamper" value="↓ Stamp at 0.00"/>
      <input type="button" id="pointMover" class="stamper" value="← Virtual stamp"/>
      <textarea id="textArea" onclick="clicker();"></textarea>
      <div>
        <div style="display:inline-block;">
            <a id="fileOutput" href="#" download="output.txt" onclick="outputFile();">Output .txt file</a>
        </div>
        <div style="display:inline-block; float: right;">
            <a href="#" onclick="setNoL();">★</a>
        </div>
      </div>

<script type="text/javascript">

// Globals
class GlobalManager {
    constructor() {
        this.playButton = document.getElementById("playButton");
        this.playButton2 = document.getElementById("playButton2");
        this.stampButton = document.getElementById("stampButton");
        this.pointMover = document.getElementById("pointMover");
        this.zoomInButton = document.getElementById("zoomInButton");
        this.zoomOutButton = document.getElementById("zoomOutButton");
        this.timerField = document.getElementById("timerField");
        this.textArea = document.getElementById("textArea");
        this.speedRange = document.getElementById("speedRange");
        this.playSpeed = document.getElementById("playSpeed");
        this.fileOutput = document.getElementById("fileOutput");
        this.currentZoomFactor = 10;
        this.minimumZoomFactor = 10;
        this.zoomDelta = 5;
        this.startPoint = 0.0;
        this.nextCandidatePoint = 0.0;
    }
}

const G = new GlobalManager();

history.pushState(null, null, null);
window.addEventListener("popstate", function(evt) {
    if (!evt.originalEvent.state) {
        history.pushState(null, null, null);
        return;
    }
});

G.textArea.rows = 10;
initParm();

function initParm() {
    const urlParm = location.search.substring(1);
    if (urlParm != "") {
        const args = urlParm.split("&");
        for (let i = 0; i < args.length; i++) {
            checkAndModify(args[i]);
        }
    }
}
function checkAndModify(parm) {
    const parmPair = parm.split("=");
    if (typeof parmPair[1] !== "undefined") {
        if (parmPair[0].toUpperCase() == "L") {
            G.textArea.rows = Number(parmPair[1]);
        }
    }
}


// Wavesurfer setup
let wavesurfer = WaveSurfer.create({
    container: '#waveform' ,
    waveColor: '#6495ed',
    progressColor: '#b03a2e',
    backend: 'MediaElement'     // it is to change speed without affecting the pitch
});

wavesurfer.on("play", function() {
    G.playButton.value = "Release to Stop";
    G.playButton2.value = "Click to Stop";
});

wavesurfer.on("pause", function() {
    playButton.disabled = false;
    changeButtonLabel();
});

wavesurfer.on("finish", function() {
    playButton.disabled = false;
    changeButtonLabel();
    wavesurfer.seekTo(0);
});

//wavesurfer.setHeight(50);

function changeButtonLabel() {
    G.playButton.value = "Play from " + getTime(G.startPoint) + " ";
}

// Stopwatch control
let timer = function() {
    let rawTime = wavesurfer.getCurrentTime();
    G.timerField.value = getTime(rawTime);
    G.stampButton.value = "↓ Stamp at " + getTime(G.nextCandidatePoint) + " ";
    if (!wavesurfer.isPlaying()) {
        G.playButton2.value = "Play from " + getTime(wavesurfer.getCurrentTime()) + " ";
    }
    G.nextCandidatePoint = rawTime;
};
setInterval(timer, 10);

// File reader
window.addEventListener('DOMContentLoaded', function() {
    let obj1 = document.getElementById("mediaFile");
    obj1.addEventListener("change",function(evt){
        let file = evt.target.files[0];
        switch (file.name.split(".").pop()) {
        case "txt" :
            let reader = new FileReader();
            reader.readAsText(file);
            reader.onload = function () {
                G.textArea.value = reader.result;
            }
            break;
        default:
            wavesurfer.load(window.URL.createObjectURL(file));
            G.startPoint = 0.0;
            changeButtonLabel();
            G.playButton.disabled = false;
            G.playButton2.disabled = false;
        }
    },false);
});

function outputFile() {
    let bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
    let blob = new Blob([ bom,  G.textArea.value ], { "type" : "text/plain" });
    if (window.navigator.msSaveBlob) { 
        window.navigator.msSaveBlob(blob, "timeStamped.json"); 
        window.navigator.msSaveOrOpenBlob(blob, "timeStamped.json"); 
    } else {
        G.fileOutput.href = window.URL.createObjectURL(blob);
    }
}

window.addEventListener('keydown', function(evt) {
    if (evt.key == "Alt") {
        if (evt.code == "AltLeft") {
            if (evt.shiftKey) {
                stampIt(evt);
            } else {
                playStart();
            }
        } else {    // AltRight
            if (evt.shiftKey) {
                setCTTM();
            } else {
                if (wavesurfer.isPlaying()) {
                    wavesurfer.pause();
                } else {
                    wavesurfer.play();
                }
            }
        }
        evt.preventDefault();
    }
});

window.addEventListener('keyup', function(evt) {
    if (evt.code == "AltLeft") {
        playStop();
    }
});

G.playButton.addEventListener("mousedown", function(evt) {
    playButton2.disabled = true;
    playStart();
});

G.playButton.addEventListener("mouseup", function(evt) {
    playButton2.disabled = false;
    playStop();
    G.textArea.focus();
});

G.playButton.addEventListener("touchstart", function(evt) {
    playStart();
});

G.playButton.addEventListener("touchend", function(evt) {
    playStop();
});

G.playButton2.addEventListener("click", function(evt) {
    if (wavesurfer.isPlaying()) {
        wavesurfer.pause();
    } else {
        playButton.disabled = true;
        wavesurfer.play();
    }
});

G.pointMover.addEventListener("click", function(evt) {
    setCTTM();
});

function playStart() {
    wavesurfer.play(G.startPoint);
}

function playStop() {
    wavesurfer.pause();
    G.nextCandidatePoint = wavesurfer.getCurrentTime();
}

G.stampButton.addEventListener("click", function(evt) {
    stampIt(evt);
});

function stampIt(evt) {
    G.startPoint = G.nextCandidatePoint;
    changeButtonLabel();
    let saveIt = textArea.selectionStart;
    let stampVal = "[[" + getTime(G.startPoint) + "]]";
    G.textArea.value = G.textArea.value.substring(0, saveIt) + stampVal + 
            G.textArea.value.substring(G.textArea.selectionEnd);
    saveIt += stampVal.length;
    G.textArea.setSelectionRange(saveIt, saveIt);
    G.textArea.focus();   // to make chrome happy.
}

function getTime(currentTime) {
    let ct = Math.floor(currentTime * 100);
    let hour = Math.floor(ct / 360000);
    let minute = Math.floor(ct % 360000 / 6000);
    let sec = Math.floor(ct % 6000 / 100);
    let csec = Math.floor(ct % 100);
    if (hour == 0) {
        if (minute == 0) {
            return sec + "." + ("00" + csec).slice(-2);
        }
        return minute + ":" + ("00" + sec).slice(-2) + "." + ("00" + csec).slice(-2);
    }
    return hour + ":" + ("00" + minute).slice(-2) + ":" + ("00" + sec).slice(-2) + "." + ("00" + csec).slice(-2);
}

function stringTimeToSec(str) {
    let parts = str.split(/:/);
    let factor = 1;
    let val = 0;
    for (let i = parts.length - 1; i >= 0; i--) {
        val += factor * parts[i];
        factor *= 60;
    }
    return val;
}

function clicker() {
    let dat = G.textArea.value;
    let pt = G.textArea.selectionStart;

    let leftValue = dat.substring(0, pt);
    let rightValue = dat.substring(pt);
    let a = leftValue.lastIndexOf("[[");
    let b = leftValue.lastIndexOf("]]");
    if ((a == -1) || (b > a)) {
        return;
    }
    let c = rightValue.indexOf("]]");
    let timeValue = leftValue.substring(a+2) + rightValue.substring(0, c);
    G.textArea.selectionStart = pt + c + 2;
    G.startPoint = stringTimeToSec(timeValue);
    wavesurfer.play(G.startPoint, G.startPoint+0.004);
}

// Called when zoom-in button is pushed.
function zoomIn() {
    G.zoomOutButton.disabled = false;
    G.currentZoomFactor += G.zoomDelta;
    wavesurfer.zoom(G.currentZoomFactor);
}

// Called when zoom-out button is pushed.
function zoomOut() {
    if (G.currentZoomFactor > G.minimumZoomFactor) {
        G.currentZoomFactor -= G.zoomDelta;
        wavesurfer.zoom(G.currentZoomFactor);
        if (G.currentZoomFactor == G.minimumZoomFactor) {
            G.zoomOutButton.disabled = true;
        }
    }
}

// Called when speed-slider is changed.
function speedControl() {
    let sval = G.speedRange.value / 55.0 + 0.2;
    wavesurfer.setPlaybackRate(sval);
    G.playSpeed.innerHTML = Math.floor(sval * 100);
}

function setNoL() {
    let newNoL = window.prompt("Enter number of lines for text-area:", G.textArea.rows);
    if ((newNoL == null) || (!newNoL.match(/^[0-9]+$/))) {
        return;
    }
    G.textArea.rows = newNoL;
}

function setCTTM() {
    G.startPoint = G.nextCandidatePoint;
    changeButtonLabel();
}
</script>
</body>
</html>
